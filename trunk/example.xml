<?xml version="1.0"?>
<!-- This is a convenience script used to run OB's examples 
     This allows the programmer to control exactly what parameters
		 are being passed to OB. Using unit tests is not a good idea, as
		 assertions are always enabled.
-->

<project name="OBSearchExample" xmlns:artifact="urn:maven-artifact-ant">

<target name="init">
	<property name="anttask" value="maven-ant-tasks-2.0.6.jar"/>
	<property name="jardownloadlocation" value="http://ftp.kddilabs.jp/infosystems/apache/maven/binaries/"/>
	<property name="destlocation" value=".."/>

	<property name="dbfolder" value="${user.home}/temp/obexampleTentacleOTHER/"/>

	<property name="name" value="seeder"/>

</target>

<!-- check if maven tasks have been downloaded -->
<target name="checkprerequisites">
<condition property="mavenanttaskavailable">
      <available file="../${anttask}"/>
</condition>
</target>

<!-- download maven tasks -->
<target name="downloadprerequisites" unless="mavenanttaskavailable" depends="checkprerequisites, init">

	<get src="${jardownloadlocation}/${anttask}" dest="${destlocation}/${anttask}"/>
	
</target>

<!-- initialize maven tasks-->
<target name="maven" depends="init, downloadprerequisites">
	
	<path id="maven-ant-tasks.classpath" path="${destlocation}/${anttask}" />
	<typedef resource="org/apache/maven/artifact/ant/antlib.xml" uri="urn:maven-artifact-ant"
           classpathref="maven-ant-tasks.classpath" />
	<!-- access maven project -->
	<artifact:pom id="project" file="pom.xml" />
	<!-- define the classpath -->

	
	<!-- generate the classpath -->
	<artifact:dependencies pathId="dependency.classpath">
      <pom refid="project"/>
  </artifact:dependencies>
	<echo>
		Local class path ${project.build.outputDirectory}
	</echo>

	<!-- DB and QUERY datafiles -->

	<property name="dbdata" value="${project.build.outputDirectory}/slices-small"/>
	<property name="querydata" value="${project.build.outputDirectory}/slices-query"/>
</target>

 
<target name="create" depends="maven">
	 <delete dir="${dbfolder}"/>
	    <mkdir dir="${dbfolder}"/>

	    <java dir="${project.build.outputDirectory}" fork="yes" classpath="${project.build.outputDirectory}:${project.build.testOutputDirectory}" classpathref="dependency.classpath" classname="org.ajmm.obsearch.example.OBExampleTrees"  failonerror="true">
				<jvmarg value="-ea" />
				<jvmarg value="-server" />
				<jvmarg value="-Xmx1000M" />
				<arg value="-create"/>
				<arg value="-db"/>
				<arg value="${dbfolder}"/>
				<arg value="-data"/>
				<arg value="${dbdata}"/>
				<arg value="-od"/>
				<arg value="6"/>
			</java>
</target>

<target name="search" depends="maven">
	<java dir="${project.build.outputDirectory}" fork="yes" classpath="${project.build.outputDirectory}:${project.build.testOutputDirectory}" classpathref="dependency.classpath"   classname="org.ajmm.obsearch.example.OBExampleTrees"  failonerror="true">
				<jvmarg value="-server" />
<!--				<jvmarg value="-ea"/>-->
				<jvmarg value="-Xmx1000M" />
				<arg value="-search"/>
				<arg value="-r"/>
				<arg value="3"/>
				<arg value="-k"/>
				<arg value="2"/>
				<arg value="-db"/>
				<arg value="${dbfolder}"/>
				<arg value="-data"/>
				<arg value="${querydata}"/>
			</java>
</target>


<target name="p2pinit" depends="maven">
	    <property name="seederFolder" value="${dbfolder}/seeder/"/>
			<property name="leecherFolder" value="${dbfolder}/leecher/"/>
	    <property name="spore" value="${seederFolder}/std/PPTreeShort"/>
			
		

			
</target>

<target name="p2pcreate" depends="p2pinit">

	<delete dir="${seederFolder}"/>
	<mkdir dir="${seederFolder}"/>	

<java dir="${project.build.outputDirectory}" fork="yes" classpath="${project.build.outputDirectory}:${project.build.testOutputDirectory}" classpathref="dependency.classpath" classname="org.ajmm.obsearch.example.OBSearchExample"  failonerror="true">
				<jvmarg value="-ea" />
				<jvmarg value="-server" />
				<jvmarg value="-Xmx1000M" />
				<arg value="-create"/>
				<arg value="-db"/>
				<arg value="${seederFolder}"/>
				<arg value="-data"/>
				<arg value="${dbdata}"/>
				<arg value="-od"/>
				<arg value="2"/>
				<arg value="-name"/>
				<arg value="${name}"/>
			</java>

</target>

<target name="p2psearchremote" depends="p2pinit">
	  <!--TODO: remove this -->
    <exec failonerror="true" executable="rsync">
				<arg value="-az"/>
				<arg value="."/>
				<arg value="${ip}:~/gsoc/obsearch/"/>
		</exec>		

    <exec executable="scp" failonerror="true">
				<arg value="${spore}"/>
				<arg value="${ip}:${spore}"/>
		</exec>

		<exec executable="ssh">
			  <arg value="${ip}"/>
			  <arg value="killall java"/>
		</exec>

		<exec executable="ssh" failonerror="true">
			  <arg value="${ip}"/>
			  <arg value="/bin/bash -i  -c 'cd ~/gsoc/obsearch/; ant -buildfile example.xml p2psearch -Dname=${ip}'"/>
		</exec>

</target>

<target name="p2psearch" depends="p2pinit">

<delete dir="${leecherFolder}"/>
 <mkdir dir="${leecherFolder}"/>




<java dir="${project.build.outputDirectory}" fork="yes" classpath="${project.build.outputDirectory}:${project.build.testOutputDirectory}" classpathref="dependency.classpath"   classname="org.ajmm.obsearch.example.OBSearchExample"  failonerror="true">
				<jvmarg value="-ea" />
				<jvmarg value="-server" />
				<jvmarg value="-Xmx1000M" />
				<arg value="-spore"/>
				<arg value="${spore}"/>
				<arg value="-search"/>
				<arg value="-r"/>
				<arg value="3"/>
				<arg value="-k"/>
				<arg value="2"/>
				<arg value="-db"/>
				<arg value="${leecherFolder}"/>
				<arg value="-data"/>
				<arg value="${querydata}"/>
				<arg value="-name"/>
				<arg value="${name}"/>
			</java>
</target>

<target name="p2p" depends="p2pinit">
			<parallel>
			<!-- Parallel task #1 -->
	    <antcall target="p2pcreate"/>
			<!-- Parallel task #2 -->
			<sequential>
			<!-- Wait for the spore -->
		  <waitfor maxwait="1" maxwaitunit="day">
        <available file="${spore}"/>
			</waitfor>
			<waitfor maxwait="1" maxwaitunit="day">
				 <socket server="127.0.0.1" port="9701"/>
			</waitfor>
			<echo>Spore file found!</echo>	
			<parallel>
			<antcall target="p2psearchremote">
			  <param name="ip" value="192.168.1.86"/>
			</antcall>
			<antcall target="p2psearchremote">
			  <param name="ip" value="192.168.1.85"/>
			</antcall>
			</parallel>
			</sequential>
			</parallel>
</target>

</project>
